<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <title>D3 Test</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>


<style>



body {
    background-color: #212121;
}


/* 
 * contains graph-container and text-container
 */
#main-container {
    width: 100%;
    height: 100%;
    min-width: 960px;
    min-height: 540px;
    max-width: 960px;
    max-height: 540px;
    overflow: hidden;
    position: relative;
    margin: 0px auto;
}


/* Search container */

#search-container {

    width: 100%;
    height: 10%;
    margin: 0px auto;
    overflow: hidden;
    position: absolute;
    text-align:center;
}

form {
    height: 70%;
    padding: 5px;
    <!-- margin: auto auto; -->
}

input {
    height: 100%;
    width: 20%;
    margin: 0 auto;
    font-family: arial, sans-serif;
    font-size: 18px;
    font-weight: bold;
    text-transform: uppercase;
    background-color: #424242;
    outline: none;
    border: 0;
    border-radius: 3px;
    padding: 0 3px;
    color: #fff;
}


/* Left Side */

/* 
 * contains graph-chart
 */
#graph-container {
    width: 75%;
    height: 90%;
    left: 0;
    bottom: 0;
    position: absolute;
}


#graph-chart {
    background-color: #424242;
    width: 100%;
    height: 100%;
}

.chart-bar {
    fill: orange;
}


.line {
    fill: none;
    stroke: steelblue;
    stroke-width: 1px;
    <!-- shape-rendering: crispEdges; -->
}

.area {
    fill: #424242;
}

#title {
    color: #BDBDBD;
    font-size: 28px;
}

.hidden {
    opacity: 0.0;
}

#tooltip {

    text-anchor: middle;
    font-family: sans-serif;
    font-size: 11px;
    font-weight: bold;
    fill: black;
}


/* Right Side */


/* 
 * contains graph-chart
 */
#text-container {
    background-color: #424242;
    width: 24%;
    height: 90%;
    right: 0;
    bottom: 0;
    position: absolute;
    text-align: center;
}

#text-chart {
    width: 100%;
    height: 100%;
    position:absolute;
}

</style>

</head>

<body>

<div id="main-container" class="container">

    <div id="search-container" class="container">
        <form action="/view" method="POST">
            <input type="text" name="symbol">
        </form>
    </div>

    <div id="graph-container" class="container">

        <svg id="graph-chart"></svg>
    </div>

    <div id="text-container" class="container">

        <div id="text-chart"></svg>
    </div>

</div>


<script type="text/javascript">

// reduce/parse data
function getDataset(data) { 

    var dataset = [];
    
    var rowConverter = function(d) {
        var parseTime = d3.timeParse("%Y-%m-%d");
        return {
            Date: parseTime(d.Date),
            Open: parseInt(d.Open),
            Close: parseFloat(d.Close),
        }
    }

    <!-- store every 7th data to reduce number of data points -->
    data.forEach(function(d,i) {
        if (i % 7 == 0) {
            dataset.push(d);
        }
    });

    <!-- parse data -->
    dataset.forEach(function(d,i) {
        dataset[i] = rowConverter(d);
    });
    return dataset;
}

function getXScale(dataset, minW, maxW) {
    var padding = 20;
    var xScale = d3.scaleTime()
        .domain([
            d3.min(dataset, function(d) { return d.Date; }),
            d3.max(dataset, function(d) { return d.Date; }),
        ])
        .range([minW, maxW]);
    return xScale;
}

function getYScale(dataset, minH, maxH) {
    var padding = 20;
    var yScale = d3.scaleLinear()
        .domain([
            d3.min(dataset, function(d) { return d.Close })-padding,
            d3.max(dataset, function(d) { return d.Close })+padding,
        ])
        .range([maxH,minH]);
    return yScale;
}



function resize() {
    var width = parseInt(d3.select("#graph-container").style("width"));
    var height = parseInt(d3.select("#graph-container").style("height"));

    // Update the range of the scale with new width/height
    xScale.range([0, width]);
    yScale.range([height, 0]);

    // Force D3 to recalculate and update the line
    d3.select(".line")
        .attr("d", function(d) { return line(d); });
    d3.select(".area")
        .attr("d", function(d) { return area(d); });
    d3.selectAll(".chart-bar")
        .attr("x", function(d) { return xScale(d.Date); }); 
};


var data = {{.SD}}
var symbol = {{.Symbol}}
var current = {{.Current}}

var dataset = getDataset(data);

var margin = {top: 20, right: 40, bottom: 30, left: 10};
var width = parseInt(d3.select("div#graph-container").style("width"));
var height = parseInt(d3.select("div#graph-container").style("height"));
var dateFormat = d3.timeFormat("%b %d %Y");
var xScale = getXScale(dataset, 0, width);
var yScale = getYScale(dataset, 0, height);


var graph_chart = d3.select("#graph-chart")
    .append("g")
    <!-- .attr("transform", "translate(" + margin.left + "," + margin.top + ")") -->
    .on("mouseleave", function() {
        title.text(symbol + " $" + current.Close)
        d3.select(".selected")
            .classed("hidden", true)
            .classed("selected", false)
        d3.select("#tooltip")
            .classed("hidden", true)
    });


<!-- line matching data points -->
var line = d3.line()
    .x(function(d) { return xScale(d.Date); })
    .y(function(d) { return yScale(d.Close); });

<!-- area under line -->
var area = d3.area()
    .x(function(d) { return xScale(d.Date); })
    .y0(function(d) { return yScale.range()[0]; })
    .y1(function(d) { return yScale(d.Close);});

var chart_bar = (function(d) {return xScale(d.Date); });

<!-- tooltip indicating date -->
var tooltip = graph_chart.append("text")
    .attr("id", "tooltip")
    .classed("hidden", true);

graph_chart.append("path")
    .datum(dataset)
    .attr("class", "line")
    .attr("d", line);

//area upder line
<!-- graph_chart.append("path") -->
<!--     .datum(dataset) -->
<!--     .attr("class", "area") -->
<!--     .attr("d", area); -->

<!-- bar indicating current data point -->
graph_chart.selectAll("rect")
    .data(dataset)
    .enter()
    .append("rect")
    .attr("class", "chart-bar")
    .attr("x", function(d) {
        return xScale(d.Date);
    })
    .attr("y", 0)
    .attr("width", 1)
    .attr("height", height)
    .classed("hidden", true)
    .on("mouseover", function(d) {
        d3.select(".selected")
            .classed("hidden", true)
            .classed("selected", false)
        d3.select(this)
            .classed("hidden", false)
            .classed("selected", true)
        d3.select("#tooltip")
            .attr("x", xScale(d.Date))
            .attr("y", 10)
            .classed("hidden", false)
            .text(dateFormat(d.Date))
        title.text(symbol + " $" + d.Close)
    });


// text chart
var title = d3.select("div#text-container")
    .append("h1")
    .attr("id", "title")
    .text(symbol + " $" + current.Close)



d3.select(window).on('resize', resize);
resize();
    


</script>

</body>

</html>
